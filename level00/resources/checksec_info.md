# Доп информация

## checksec
**Checksec** — это простая утилита, позволяющая определить, какие свойства были включены при компиляции.
```bash
bonus0@RainFall:~$ checksec --file bonus0
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE
No RELRO        No canary found   NX disabled   No PIE          No RPATH   No RUNPATH   bonus0

```

## флаги компилляции
**RELRO** - защищает структуры исполняемого ELF-файла (изменение которых позволяет взломщику изменить ход выполнения программы)
путем модификации секций PLT (Procedure Linking Table) или GOT (Global Offset Table) ELF-файла. При полном RELRO, вся таблица GOT перед
началом исполнения в памяти помечается доступной только для чтения и таким образом предотвращает свою модификацию потенциальным злоумышленником.
Частичный режим RELRO защищает только PLT. Кроме того, оба метода реорганизуют структуры данных ELF таким образом, что упомянутые таблицы 
помещаются перед остальными структурами данных ELF, что затрудняет для атакующего кода возможность расширения GOT и PLT.

NO RELRO
```bash
$ gcc -z norelro test.c -o test
```

PARTIAL RELRO
```bash
$ gcc -z lazy test.c -o test
```

FULL RELRO
```bash
$ gcc -z now test.c -o test
```
---
**STACK CANARY** - один из способов защиты от переполнения буфера на стеке.

При переполнении буфера освовную опасность представляет перезапись адреса возврата функции. От этого канарейка и защищает.

В прологе функции за адресом возврата[4] на стек сохраняется специальное секретное значение, которое проверяется при выходе из функции. Если оно изменилось, то значит произошло переполнение буфера на стеке, и программа немедленно завершается, не выполняя инструкцию ret.

В glibc канарейка генерируется один раз при запуске программы, и никогда не меняется. Если есть уязвимость, позволяющая прочесть значение канарейки, то её можно обойти, просто записывая поверх канарейки её значение. Однако алгоритм генерации всегда включает в значение нулевой байт, что может усложнить эксплуатацию при помощи строковых функций типа strcpy.

В HexRays проверка канарейки декомпилируется неправильно. Но всегда, когда вы видите __readfsqword(0x28u), можете быть увереными, что это оно. Если хотите посмотреть корректный код, смотрите дизассемблер.

NO CANARY
```bash
 GCC-FNO-Stack-Protector -o Test Test.c // Disable Stack Protection
```

CANARY IN SOME FUNCTIONS
```bash
 GCC -FSTACK-Protector -o Test Test.c // Enables stack protection, but only the function in which the CHAR array is included in the local variable into the protection code
```

CANARY IN ALL FUNCTIONS
```bash
 GCC -FSTACK-Protector-All -o Test Test.c // Enables stack protection to insert protection code for all functions
```
---
**NX** - бит запрета исполнения, добавленный в страницы (см. таблицы страниц (англ.)) для реализации возможности предотвращения
выполнения данных как кода. Используется для предотвращения уязвимости типа «переполнение буфера», позволяющей выполнять произвольный
код на атакуемой системе локально или удалённо. Технология требует программной поддержки (см. DEP) со стороны ядра операционной системы.

NX 
```bash
$ gcc -z execstack -o test test.c
```
No NX
```bash
$ gcc -z noexecstack -o test test.c
```

---
**PIE** - Включённое свойство PIE позволяет произвольно размещать в памяти исполняемый код независимо от его абсолютного адреса:

PIE (Position Independent Executable) — исполняемый позиционно-независимый код. Возможность предсказать, где и какие области памяти находятся в адресном пространстве процесса играет на руку взломщикам. Пользовательские программы загружаются и выполняются с предопределённого адреса виртуальной памяти процесса, если они не скомпилированы с опцией PIE. Использование PIE позволяет операционной системе загружать секции исполняемого кода в произвольные участки памяти, что существенно усложняет взлом.

PIE
```bash
$ gcc -fpie -pie -o test test.c
```

NO PIE
```bash
$ gcc -o test test.c
```
---
**RPATH / RUNPATH** - Переменная среды запущенной программы, файлы разделяемой библиотеки, необходимые во время работы, сначала ищутся из этого каталога, что может вызвать атаки поддельной библиотеки.
 Переменная среды запущенной программы, файлы разделяемой библиотеки, необходимые во время работы, сначала ищутся из этого каталога, что может вызвать атаки поддельной библиотеки.
```bash
-Wl, - disable-new-dtags // indicates RPath
-Wl, - enable-new-dtags // Take Runpath 
```

RPATH
```bash
$ gcc -o test test.c -Wl,-rpath,./
$ readelf -d test

Dynamic section at offset 0xe18 contains 25 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000000f (RPATH)              Library rpath: [./]
 ...
```

RUNPATH
```bash
$ gcc -o test test.c -Wl,-rpath,./ -Wl,--enable-new-dtags
$ readelf -d test

Dynamic section at offset 0xe18 contains 25 entries:
  Tag        Type                         Name/Value
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
 0x000000000000001d (RUNPATH)            Library runpath: [./]
 ...
```